name: dataset-physics

on:
  push:
  pull_request:

jobs:
  physics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enforce dataset-only boundaries
        shell: bash
        run: |
          set -euo pipefail
          prohibited=(src app server inference runtime tools)
          hits=$(find . -type d \( -name src -o -name app -o -name server -o -name inference -o -name runtime -o -name tools \) -not -path "./.git/*")
          if [ -n "$hits" ]; then
            echo "Prohibited runtime paths detected:"
            echo "$hits"
            exit 1
          fi

      - name: Secret pattern scan
        shell: bash
        run: |
          set -euo pipefail
          patterns='(BEGIN( RSA| OPENSSH)? PRIVATE KEY|AWS_SECRET_ACCESS_KEY|AKIA[0-9A-Z]{16}|ghp_[A-Za-z0-9]{36,}|xox[baprs]-[0-9A-Za-z-]{10,48})'
          if git grep -n -I -E "$patterns"; then
            echo "Potential secrets detected. Remove before commit."
            exit 1
          fi

      - name: Parse JSON/YAML (best effort)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          import sys

          yaml_available = False
          try:
            import yaml  # type: ignore
            yaml_available = True
          except Exception:
            pass

          errors = []
          for root, _, files in os.walk("."):
            if root.startswith("./.git"):
              continue
            for filename in files:
              path = os.path.join(root, filename)
              if filename.endswith(".json"):
                try:
                  with open(path, "r", encoding="utf-8") as handle:
                    json.load(handle)
                except Exception as exc:
                  errors.append(f"JSON parse failed: {path}: {exc}")
              elif filename.endswith((".yml", ".yaml")) and yaml_available:
                try:
                  with open(path, "r", encoding="utf-8") as handle:
                    yaml.safe_load(handle)
                except Exception as exc:
                  errors.append(f"YAML parse failed: {path}: {exc}")

          if errors:
            print("\n".join(errors))
            sys.exit(1)
          PY
